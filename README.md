# Helm on minikube

## Prerequisits

Note: [Chocolatey](https://chocolatey.org/) will make the setup process easier by a lot and is recommended.

### Hyper-V and Docker

1. Activate the Hyper-V hypervisor via the windows feature menu.
2. Download and install Docker for Windows from [hub.docker.com] (you will need a Docker Hub account for that)
3. Create a network switch which sahres the internet connection with the minikube-vm.

### kubectl

1. Install kubectl with chocolatey via `choco install kubernetes-cli`

Alternatively you can install the binaries directly.

2. Download [kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl-on-windows), v1.17.0 can be downloaded directly via [this link](https://storage.googleapis.com/kubernetes-release/release/v1.17.0/bin/windows/amd64/kubectl.exe)
3. Copy the downloaded executable to any folder you like ( f.e. C:\kubectl\)
4. Add the folder to your PATH environmental variable

### Install and start minikube

1. Install minikube via ``choco install minikube``
2. Start minikube with the correct driver and switch by executing `minikube start --vm-driver hyperv --hyperv-virtual-switch "<the name of your switch>"` (this may take a while, especially at first start)
3. Check the status with `minikube status` to see if kubectl is configured correctly

### Install helm

1. Install Helm via ``choco install kubernetes-helm``

Alternatively you can install the binaries directly.

2. Download your [desired Helm version](https://github.com/helm/helm/releases)
3. Unpack it to any folder you wish and add that folder to you PATH environmental variable

## Generating the first helm chart

You can generate a basic helm chart by executing ``helm create example-chart``. Helm will automatically create a subdirecotry which contains a ``Chart.yaml`` and a ``values.yaml``, together with two other subdirectories. You might want to take a look at the ``templates`` subdirectory, but do not modify them yet.

We now want to use our own image instead of the one that was pregenerated by Helm. Open the ``Chart.yaml`` file in any editor you like. This file contains basic information about the application and the chart itsself. Change the name to ``helm-example`` and change the appVersion to the tag of the Docker Image you want to use ( f.e. ``latest``). We need to that because helm automatically attaches the appVersion at the end of the image name. Safe the changes and open the ``values.yaml`` file.

This file contains more specific information about the image we are using and how it is implemented in kubernetes. Change the image to the image you want to use (f.e. ``klibio/io.klib.aries.example``). As our example image is a webservice we need to specify a service which exposes this webservice at a specific port. Kubernetes provides the NodePort service to that. Change the service type to ``NodePort`` and the port to the port your container is listening on. For our example image it is 8080.

You might want to overwrite a setting with an argument at the moment you are installing the chart, for example ``helm install ./example-chart --set service.internalPort=80`` This will overwrite the port in which the NodePort service will listen to.

The last thing we need to change is the port on which kubernetes will perform its Liveness and Readiness probes. To change that navigate to the templates folder and edit ``deployment.yaml``. Change the in the http named port specified container port to the same port you specified the NodePort with, which is 8080 in our example.

Now install your helm chart with ``helm install helm-example ./helm-example``. Note that this command needs to be performed in the parent directory, where you created the chart.

Check ``kubectl get all`` if your configuration has been deployed.

## Packaging the helm chart

You can package your helm chart by executing ``helm package ./helm-example``. This will generate a tgz package which can be used by other to install your exact configuration of that deployment with ``helm install example helm-example-0.1.0.tgz``. Please note that this will use the in the ``Chart.yaml`` file specified version in the package name, which is 0.1.0 by default.

This repositorie provides you with a fully configured example chart which can also be found as package in the packed subdirectory.